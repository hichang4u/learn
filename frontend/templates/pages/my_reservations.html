{% extends "layout/app.html" %}

{% block title %}내 신청 현황{% endblock %}

{% block main_content %}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="h4 mb-0">내 신청 현황</h2>
        <a href="/request" class="btn btn-primary">
            <i class="fas fa-plus"></i> 새로운 신청
        </a>
    </div>

    <div class="card">
        <div class="card-body">
            <div id="reservationList" class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>플랫폼</th>
                            <th>계정</th>
                            <th>시작일</th>
                            <th>종료일</th>
                            <th>상태</th>
                            <th>메모</th>
                            <th>신청일</th>
                        </tr>
                    </thead>
                    <tbody id="reservationTableBody">
                        <!-- 예약 목록이 여기에 동적으로 로드됩니다 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<style>
.status-badge {
    padding: 0.35em 0.65em;
    font-size: 0.75em;
    font-weight: 600;
    border-radius: 0.25rem;
}

.status-PENDING {
    background-color: var(--bs-warning);
    color: var(--bs-dark);
}

.status-APPROVED {
    background-color: var(--bs-info);
    color: var(--bs-white);
}

.status-IN_USE {
    background-color: var(--bs-primary);
    color: var(--bs-white);
}

.status-COMPLETED {
    background-color: var(--bs-success);
    color: var(--bs-white);
}

.status-REJECTED {
    background-color: var(--bs-danger);
    color: var(--bs-white);
}

.status-CANCELLED {
    background-color: var(--bs-secondary);
    color: var(--bs-white);
}
</style>

<script>
// 상태별 한글 텍스트
const statusText = {
    'PENDING': '대기중',
    'APPROVED': '승인됨',
    'IN_USE': '사용중',
    'COMPLETED': '완료',
    'REJECTED': '거절됨',
    'CANCELLED': '취소됨'
};

// 예약 목록 로드
async function loadReservations() {
    try {
        const response = await fetch('/api/reservations');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const reservations = await response.json();
        
        const tableBody = document.getElementById('reservationTableBody');
        if (reservations.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center py-4">
                        <p class="text-muted mb-0">신청 내역이 없습니다.</p>
                        <a href="/request" class="btn btn-primary mt-3">
                            <i class="fas fa-plus"></i> 새로운 신청하기
                        </a>
                    </td>
                </tr>
            `;
            return;
        }

        tableBody.innerHTML = reservations.map(reservation => `
            <tr>
                <td>
                    <div class="d-flex align-items-center">
                        <img src="${reservation.account.platform.logo || '/static/img/default-platform.png'}" 
                             alt="${reservation.account.platform.name}"
                             class="me-2"
                             style="width: 24px; height: 24px; object-fit: contain;">
                        ${reservation.account.platform.name}
                    </div>
                </td>
                <td>${reservation.account.email}</td>
                <td>${new Date(reservation.start_date).toLocaleDateString()}</td>
                <td>${new Date(reservation.end_date).toLocaleDateString()}</td>
                <td>
                    <span class="status-badge status-${reservation.status}">
                        ${statusText[reservation.status]}
                    </span>
                </td>
                <td>
                    <span class="text-muted small">
                        ${reservation.memo || '-'}
                    </span>
                </td>
                <td>
                    <span class="text-muted small">
                        ${new Date(reservation.created_at).toLocaleString()}
                    </span>
                </td>
            </tr>
        `).join('');
    } catch (error) {
        console.error('예약 목록 로드 실패:', error);
        if (error.message.includes('401')) {
            alert('세션이 만료되었습니다. 다시 로그인해주세요.');
            window.location.href = '/login';
        } else {
            alert('예약 목록을 불러오는데 실패했습니다.');
        }
    }
}

// 페이지 로드 시 예약 목록 로드
document.addEventListener('DOMContentLoaded', loadReservations);
</script>
{% endblock %} 